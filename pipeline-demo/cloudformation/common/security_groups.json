{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Security Groups",

  "Parameters" : {
    "PLAYVPCCIDR": {
      "Description": "Ahead UAT VPC CIDR",
      "Type": "String",
       "Default": "10.3.128.0/17"
    },
    "DEVVPCCIDR": {
      "Description": "Ahead UAT VPC CIDR",
      "Type": "String",
       "Default": "10.3.0.0/17"
    },
    "UATVPCCIDR": {
      "Description": "Ahead secondary CIDR",
      "Type": "String",
       "Default": "10.4.128.0/17"
    },
    "PRODVPCCIDR": {
      "Description": "Ahead secondary CIDR",
      "Type": "String",
       "Default": "10.4.0.0/17"
    },
    "ProductName": {
      "Description": "The Ahead Product name",
      "Type": "String",
      "Default": "HL"
    },
    "Environment": {
      "Description": "The application environment",
      "Type": "String",
      "Default": ""
    },
    "VPCID":{
      "Description" : "ID of the VPC.",
      "Type" : "String",
      "Default" : ""
    },
    "VPCCIDR" : {
      "Description" : "CIDR block of the VPC.",
      "Type" : "String",
      "MinLength" : "9",
      "MaxLength" : "18",
      "Default" : "10.4.0.0/16",
      "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription" : "Must be valid CIDR notation (i.e. x.x.x.x/x)."
    },
    "OpsIpOne" : {
      "Description" : "Remote Ops IP.",
      "Type" : "String",
      "MinLength" : "9",
      "MaxLength" : "18",
      "Default" : "0.0.0.0/0",
      "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription" : "Must be valid CIDR notation (i.e. x.x.x.x/x)."
    },
    "AheadOpsCIDR" : {
      "Description" : "CIDR block of the Ahead-Ops account. Used for VPC peering.",
      "Type" : "String",
      "MinLength" : "9",
      "MaxLength" : "18",
      "Default" : "10.0.88.0/21",
      "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription" : "Must be valid CIDR notation (i.e. x.x.x.x/x)."
    }


  },

  "Resources" : {

    "BastionSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable communication to the bastion host",
        "VpcId" : { "Ref" : "VPCID" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "3389", "ToPort" : "3389", "CidrIp" : { "Ref": "VPCCIDR" } }
        ],
        "SecurityGroupEgress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "udp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "Product", "Value" : { "Ref": "ProductName" } },
          { "Key" : "Name", "Value": { "Fn::Join": [ "", [ "Bastion", "-", {"Ref":"Environment"} ] ] } }
        ]
      }
    },

    "CommonSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable communication to the common host",
        "VpcId" : { "Ref" : "VPCID" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : { "Ref": "VPCCIDR" } }
        ],
        "SecurityGroupEgress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "udp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "Product", "Value" : { "Ref": "ProductName" } },
          { "Key" : "Name", "Value": { "Fn::Join": [ "", [ "Common", "-", {"Ref":"Environment"} ] ] } }
        ]
      }
    },



    "JenkinsSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable communication to the Jenkins CI Server  host",
        "VpcId" : { "Ref" : "VPCID" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "icmp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "8080", "ToPort" : "8081", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "3389", "ToPort" : "3389", "CidrIp" : { "Ref": "VPCCIDR" } }
        ],
        "SecurityGroupEgress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "udp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "Product", "Value" : { "Ref": "ProductName" } },
          { "Key" : "Name", "Value": { "Fn::Join": [ "", [ "Jenkins", "-", {"Ref":"Environment"} ] ] } }
        ]
      }
    },

    "JenkinsELBSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable communication to the Jenkins CI Server ELB",
        "VpcId" : { "Ref" : "VPCID" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "icmp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "8080", "ToPort" : "8081", "CidrIp" : { "Ref": "VPCCIDR" } }
        ],
        "SecurityGroupEgress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "udp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "Product", "Value" : { "Ref": "ProductName" } },
          { "Key" : "Name", "Value": { "Fn::Join": [ "", [ "JenkinsELB", "-", {"Ref":"Environment"} ] ] } }
        ]
      }
    },


    "PackerSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable communication for Packer-Build hosts",
        "VpcId" : { "Ref" : "VPCID" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "tcp", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : { "Ref": "VPCCIDR" } },
          { "IpProtocol" : "udp", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : { "Ref": "VPCCIDR" } }
        ],
        "SecurityGroupEgress" : [
          { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "udp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" }
        ],
        "Tags" : [
          { "Key" : "project", "Value" : { "Ref": "ProductName" } },
          { "Key" : "Name", "Value": { "Fn::Join": [ "", [ "Packer", "-", {"Ref":"Environment"} ] ] } }
        ]
      }
    }


  },

  "Outputs": {

    "BastionSecurityGroup" : {
      "Description" : "ID of the bastion security group",
      "Value" : { "Ref" : "BastionSecurityGroup" }
    },
    "CommonSecurityGroup" : {
      "Description" : "ID of the common security group",
      "Value" : { "Ref" : "CommonSecurityGroup" }
    },
    "JenkinsSecurityGroup" : {
      "Description" : "ID of the jenkins security group",
      "Value" : { "Ref" : "JenkinsSecurityGroup" }
    },
    "JenkinsELBSecurityGroup" : {
      "Description" : "ID of the jenkins elb security group",
      "Value" : { "Ref" : "JenkinsELBSecurityGroup" }
    },
    "PackerSecurityGroup" : {
      "Description" : "ID of the Packer-Build security group",
      "Value" : { "Ref" : "PackerSecurityGroup" }
    }

  }
}
